version: 2.1

#orbs:
#  codecov: codecov/codecov@1.0.4

jobs:
  build:
    working_directory: ~/
    docker:
      - image: docker
    environment:
      NAME: Ubuntu
      BUILD_TYPE: Debug
      CC: clang
      CXX: clang++
    steps:
      - restore_cache:
        keys:
          - source-v1-{{ .Branch }}-{{ .Revision }}
          - source-v1-{{ .Branch }}-
          - source-v1-
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - save_cache:
        key: source-v1-{{ .Branch }}-{{ .Revision }}
        paths:
          - ".git"
      - restore_cache:
        keys: cache-id_{{ .Environment.NAME }}-{{ .Environment.CC }}-{{ .Environment.BUILD_TYPE }}
      - run:
        command: |
          umask 000
          git clone https://github.com/Niram7777/nvidia-docker.git
          make ubuntu-latest -C nvidia-docker &> nvidia-docker.log
          docker build --build-arg U_ID="$(id -u)" --build-arg G_ID="$(id -g)" -t rpcs3 - < Dockerfile &> rpcs3-docker.log
          source .dockerrc
          ls *
          docker_rpcs3 -u -m -t -c
          bash <(curl -s https://codecov.io/bash) -s coverage/
      - save_cache:
        key: cache-id_{{ .Environment.NAME }}-{{ .Environment.CC }}-{{ .Environment.BUILD_TYPE }}
        paths:
          - Docker_"$BUILD_TYPE"_"$CC"
          - ~/.ccache
      - store_artifacts:
        path: Docker_"$BUILD_TYPE"_"$CC"
      - store_test_results:
        path: coverage

